<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iVote | Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/design4.css') }}">
</head>

<body>
  <header class="page-header">
    <button id="sidebarToggle" aria-label="Toggle Sidebar">â˜°</button>
    <div class="logo-container">
      <div class="logo-wrapper"><img src="{{ url_for('static', filename='images/isu.png') }}" alt="Logo" class="logo" />
      </div>
      <div class="logo-wrapper"><img src="{{ url_for('static', filename='images/osas.png') }}" alt="Logo"
          class="logo" /></div>
      <div class="logo-wrapper"><img src="{{ url_for('static', filename='images/ssc.png') }}" alt="Logo" class="logo" />
      </div>
    </div>
    <div class="header-title">VOTING SYSTEM
    </div>
  </header>

  <div class="sidebar">
    <h2>Dashboard</h2>
    {% if dept_logo %}
    <div style="text-align:center; margin-bottom:18px;">
      <img src="{{ url_for('static', filename='images/' ~ dept_logo) }}" alt="Department Logo"
        style="height:70px;max-width:120px;object-fit:contain;">
      <div style="color:#fff; font-size:15px; margin-top:6px;">{{ user.department }}</div>
    </div>
    {% endif %}
    <div class="user-divider">
      <div class="line-container">
        <hr><span class="username">WELCOME</span>
        <hr>
      </div>
      <span class="user-name">
        {{ user.first_name }} {{ user.last_name }}
      </span>
      <hr>
    </div>
    <a href="#" id="homeLink">
      <i class="fa-solid fa-house"></i>
      <span>Home</span>
    </a>
    <a href="#" id="profileLink">
      <i class="fa-solid fa-user"></i>
      <span>My Profile</span>
    </a>
    <a href="{{ url_for('vote_receipt') }}">
      <i class="fa-solid fa-receipt"></i>
      <span>Receipt Tab</span>
    </a>
    <a href="{{ url_for('candidates') }}">
      <i class="fa-solid fa-users"></i>
      <span>Candidates</span>
    </a>
    <a href="{{ url_for('view_results') }}">
      <i class="fa-solid fa-chart-bar"></i>
      <span>View Results</span>
    </a>
    <a href="{{ url_for('activity') }}">
      <i class="fa-solid fa-list-check"></i>
      <span>View Activities</span>
    </a>
    <a href="{{ url_for('blockchain_html') }}">
      <i class="fa-solid fa-shield-halved"></i>
      <span>Vote Audit Trail</span>
    </a>
    <a href="{{ url_for('logout') }}" onclick="return confirm('Are you sure you want to logout?');">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>Logout</span>
    </a>
  </div>

  <div class="main-content">
    <div class="main-wrapper">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
      {% endif %}
      {% endwith %}
      <h2>{{ user.department }} Dashboard</h2>
      <p>
        Voting Start: <b>{{ voting_start_display }}</b> |
        Voting Deadline: <b>{{ voting_end_display }}</b> |
        Now: <b id="liveNow">{{ now.strftime('%Y-%m-%d %H:%M:%S') }}</b>
      </p>

      <div class="sketch-container">
        {% if voting_closed %}
        <div style="text-align:center; color:#e74c3c; font-size:1.2em; font-weight:bold; margin:40px 0;">
          Voting has ended.<br>
          Thank you for your participation.<br>
          Please view the results in <b>[View Results]</b> on the Left side of dashboard.
        </div>
        {% elif positions|length == 0 %}
        <p>No voting positions are available for your department at this time.</p>
        {% elif all_voted %}
        <div style="text-align:center; color:#25c18c; font-size:1.2em; font-weight:bold; margin:40px 0;">
          You already voted in all available positions,<br>
          Thank you for participating.<br>
          You can view the results in <b>[View Results]</b> on the Left side of the dashboard.
        </div>

        {% elif voting_start and voting_end and voting_start <= now <=voting_end %}<p>Welcome, {{ user.first_name }}!
          Please
          select your preferred candidates below.</p>
          <form method="POST" action="">

            {% for pos in positions %}
            {% if pos.id not in voted_positions %}
            <div class="position-block">
              <h3>{{ pos.name }}</h3>
              <div class="candidate-card-list">
                {% for cand in candidates_per_position[pos.id] %}
                <label class="candidate-result-card">
                  <input type="radio" name="{{ pos.id }}" value="{{ cand.id }}" required>
                  {% if cand.image %}
                  <img src="{{ url_for('static', filename=cand.image) }}" alt="{{ cand.name }}">
                  {% endif %}
                  <div class="candidate-name">{{ cand.name }}</div>
                </label>
                {% endfor %}
                {% if candidates_per_position[pos.id]|length == 0 %}
                <p>No candidates for this position yet.</p>
                {% endif %}
              </div>
            </div>
            {% endif %}
            {% endfor %}
            <button type="submit">Submit Vote</button>
          </form>
          {% endif %}
      </div>
    </div>
  </div>

  <!-- Profile Modal (simplified) -->
  <div id="profileOverlay" style="display:none;">
    <div id="profileContainer">
      <h2>YOUR PROFILE</h2>
      <div class="profile-columns">
        <div class="profile-col">
          <div class="profile-col-title">Student Information |</div>
          <div class="profile-row"><i class="fa-solid fa-id-badge"></i><strong>First Name:</strong><span>{{
              user.first_name }}</span></div>
          <div class="profile-row"><i class="fa-solid fa-id-badge"></i><strong>Last Name:</strong><span>{{
              user.last_name }}</span></div>
          <div class="profile-row"><i class="fa-solid fa-id-badge"></i><strong>Phone Number:</strong><span>{{ user.phone
              }}</span></div>
          <div class="profile-row"><i class="fa-solid fa-building-columns"></i><strong>Department:</strong><span>{{
              user.course }}</span></div>
          <div class="profile-row"><i class="fa-solid fa-road"></i><strong>Track:</strong><span>{{ user.track }}</span>
          </div>
          <div class="profile-row"><i class="fa-solid fa-layer-group"></i><strong>Year Level:</strong><span>{{
              user.year_level }}</span></div>
        </div>
        <div class="profile-col">
          <div class="profile-col-title">Login Details |</div>
          <div class="profile-row"><i class="fa-solid fa-id-card"></i><strong>School ID:</strong><span>{{
              user.school_id}}</span></div>
          <div class="profile-row"><i class="fa-solid fa-envelope"></i><strong>Email:</strong><span>{{
              user.email}}</span></div>
        </div>
        <button id="closeProfileBtn">Close</button>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const profileLink = document.getElementById('profileLink');
        const profileOverlay = document.getElementById('profileOverlay');
        const closeProfileBtn = document.getElementById('closeProfileBtn');
        if (profileLink && profileOverlay && closeProfileBtn) {
          profileLink.addEventListener('click', function (e) {
            e.preventDefault();
            profileOverlay.style.display = 'block';
          });
          closeProfileBtn.addEventListener('click', function () {
            profileOverlay.style.display = 'none';
          });
          profileOverlay.addEventListener('click', function (e) {
            if (e.target === profileOverlay) {
              profileOverlay.style.display = 'none';
            }
          });
        }
        const sidebar = document.querySelector('.sidebar');
        const toggleBtn = document.getElementById('sidebarToggle');
        if (toggleBtn && sidebar) {
          toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('active');
          });
        }
      });
    </script>
    <!-- Replace this portion in your <script> section -->

    <script>
      const votingStartStr = "{{ voting_start }}";
      const votingEndStr = "{{ voting_end }}";
      const votingClosed = {{ voting_closed | tojson }};
      let votingStart = null;
      let votingEnd = null;

      function formatDateToWords(date) {
        return date.toLocaleString("en-US", {
          timeZone: "Asia/Manila",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
          second: "2-digit",
          hour12: true
        });
      }

      function disableVotingUI(message) {
        const sketchContainer = document.querySelector('.sketch-container');
        if (sketchContainer) {
          sketchContainer.innerHTML = `
            <div style="text-align:center; color:#f39c12; font-size:1.2em; font-weight:bold; margin:40px 0;">
              ${message}
            </div>
          `;
        }
      }

      try {
        if (votingStartStr) votingStart = new Date(votingStartStr);
        if (votingEndStr) votingEnd = new Date(votingEndStr);

        const now = new Date();

        // Disable voting if current time is outside the voting period
        if (votingStart && now < votingStart) {
          disableVotingUI("Voting has not started yet. Please wait until " + formatDateToWords(votingStart));
        } else if (votingEnd && now > votingEnd) {
          disableVotingUI("Voting period has ended. Voting was open until " + formatDateToWords(votingEnd));
        }

        // Update live clock
        const liveNowElem = document.getElementById('liveNow');
        if (liveNowElem) {
          setInterval(() => {
            const now = new Date();
            liveNowElem.textContent = formatDateToWords(now);
          }, 1000);
        }

      } catch (error) {
        console.error("Error parsing start/end time:", error);
      }
    </script>

</body>

</html>