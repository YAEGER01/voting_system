<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>View Results</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/design2.css') }}">
</head>

<body>
  <header class="topbar">
    <a href="{{ url_for('admin_dashboard') }}" class="back-btn">‚Üê Back to Admin Dashboard</a>
    <div class="top-title">Voting Results</div>
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">üåì</button>
  </header>

  <main class="container">
    <section class="overview">
      <h1>Results for {{ department }}</h1>
      {% if results|length == 0 %}
      <p class="muted">No positions available for your department.</p>
      {% endif %}
    </section>

    <section class="positions">
      {% for pos_result in results %}
      {% set total_votes = pos_result.candidates|sum(attribute='vote_count') %}
      <article class="position-card">
        <div class="position-header">
          <h2 class="position-name">{{ pos_result.position.name }}</h2>
          <div class="position-meta">
            <span class="total-votes">{{ total_votes }} total vote{% if total_votes != 1 %}s{% endif %}</span>
          </div>
        </div>

        {% if pos_result.candidates|length == 0 %}
        <p class="muted">No candidates for this position.</p>
        {% else %}
        <div class="candidates-list">
          {% set max_votes = 0 %}
          {% for cand in pos_result.candidates %}
          {% if cand.vote_count > max_votes %}
          {% set max_votes = cand.vote_count %}
          {% endif %}
          {% endfor %}

          {% for cand in pos_result.candidates %}
          {% if total_votes > 0 %}
          {% set pct = (cand.vote_count / total_votes * 100) | round(1) %}
          {% else %}
          {% set pct = 0 %}
          {% endif %}
          <div class="candidate-row">
            <div class="candidate-left">
              {% if cand.image %}
              <img src="{{ url_for('static', filename=cand.image) }}" class="candidate-img" alt="Candidate">
              {% else %}
              <div class="candidate-avatar">{{ cand.name[0]|upper }}</div>
              {% endif %}
              <div class="candidate-meta">
                <div class="candidate-name">{{ cand.name }}</div>
                <div class="candidate-sub">{{ cand.party if cand.party is defined else '' }}</div>
              </div>
            </div>

            <div class="candidate-right">
              <div class="vote-row">
                <div class="vote-count">{{ cand.vote_count }}</div>
                <div class="vote-percent">{{ pct }}%</div>
              </div>

              <div class="progress" data-pct="{{ pct }}">
                <div class="progress-bar" style="width: {{ pct }}%"></div>
              </div>

              {% if cand.vote_count == max_votes and max_votes > 0 %}
              <div class="winner-badge">Winner</div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </article>
      {% endfor %}
    </section>
  </main>

  <script src="{{ url_for('static', filename='js/results.js') }}"></script>
</body>

</html>